version: 2.1

orbs:
  python: circleci/python@0.2.1

jobs:
  py36: &python-build-test
    docker:
      - image: circleci/python:3.6
    steps:
      - checkout
      - restore_cache:
          key: depsv3-{{ .Branch }}.{{ arch }}-{{ checksum "requirements_dev.txt" }}
      - run:
          name: Deps
          command: |
            sudo apt-get install cmake openssh-server
            pip install flake8 jinja2 sphinx sphinx_rtd_theme pytest
      - save_cache:
          key: depsv3-{{ .Branch }}.{{ arch }}-{{ checksum "requirements_dev.txt" }}
          paths:
            - ".venv"
            - ".cache/pip"
      - run:
          command: |
            python setup.py build_ext --inplace
            eval "$(ssh-agent -s)"
          name: Build
      - run:
          command: |
            ls -lhtr ssh/
            pwd
            pytest tests
            flake8 ssh
            python setup.py sdist
            cd dist; pip install *; cd ..
          name: Test
  py37:
    <<: *python-build-test
    docker:
      - image: circleci/python:3.7
  py38:
    <<: *python-build-test
    docker:
      - image: circleci/python:3.8
  manylinux:
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - restore_cache:
          key: manylinuxdepsv5-{{ .Branch }}.{{ arch }}
      - run:
          name: Deps
          command: |
            sudo apt-get install docker python-pip
            pip install twine
      - save_cache:
          key: manylinuxdepsv5-{{ .Branch }}.{{ arch }}
          paths:
            - ".venv"
            - ".cache/pip"
      - run:
          name: Build Wheels
          command: |
            if [[ -z "${CIRCLE_PR_NUMBER}" ]]; then
              echo "$DOCKER_PASSWORD" | docker login -u="$DOCKER_USERNAME" --password-stdin;
            fi
            ./ci/travis/build-manylinux.sh

workflows:
  version: 2.1
  main:
    jobs:
      # - py36
      # - py37
      # - py38
      - manylinux:
          context: Docker
      # - manylinux:
      #     context: Docker
      #     requires:
      #       - py36
      #       - py37
      #       - py38
