version: 2.1

orbs:
  python: circleci/python@0.2.1

jobs:
  py36: &python-build-test
    docker:
      - image: circleci/python:3.6
    steps:
      - checkout
      - restore_cache:
          key: depsv3-{{ .Branch }}.{{ arch }}-{{ checksum "requirements_dev.txt" }}
      - run:
          name: Deps
          command: |
            sudo apt-get install cmake openssh-server
            pip install flake8 jinja2 sphinx sphinx_rtd_theme pytest
      - save_cache:
          key: depsv3-{{ .Branch }}.{{ arch }}-{{ checksum "requirements_dev.txt" }}
          paths:
            - ".venv"
            - ".cache/pip"
      - run:
          command: |
            python setup.py build_ext --inplace
            eval "$(ssh-agent -s)"
          name: Build
      - run:
          command: |
            ls -lhtr ssh/
            pwd
            pytest tests
            flake8 ssh
            python setup.py sdist
            cd dist; pip install *; cd ..
          name: Test
  py37:
    <<: *python-build-test
    docker:
      - image: circleci/python:3.7
  py38:
    <<: *python-build-test
    docker:
      - image: circleci/python:3.8
  manylinux:
    docker:
      - image: circleci/python:default
    steps:
      - checkout
      - restore_cache:
          key: manylinuxdepsv3-{{ .Branch }}.{{ arch }}
      - run:
          name: Deps
          command: |
            sudo apt-get install docker
            pip install twine
      - save_cache:
          key: manylinuxdepsv3-{{ .Branch }}.{{ arch }}
          paths:
            - ".venv"
            - ".cache/pip"
            - "/usr/local/bin"
      - run:
          name: Build Wheels
          command: |
            if [[ -z "$CIRCLE_PR_NUMBER" ]]; then docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"; fi
            ./ci/travis/build-manylinux.sh

workflows:
  version: 2.1
  main:
    jobs:
      - py36
      - py37
      - py38
      - manylinux:
          context: Docker
          requires:
            - py36
            - py37
            - py38
